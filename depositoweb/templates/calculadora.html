{% extends "base.html" %}

{% block title %}Calculadora de Espacio OberáBox{% endblock %}

{% block head_extra %}
    <!-- Estilos movidos a depositoweb/static/style.css para un tema moderno -->
{% endblock %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-9">
            <div class="card shadow-lg p-4">
                <h1 class="card-title text-center mb-4">Calculadora de Depósito</h1>
                <hr class="divider"> {# Añadido el divisor #}

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <div class="row">
                    <div class="col-lg-7 border-end pe-lg-4">
                        <h4 class="mb-3">Selecciona los elementos de cada ambiente:</h4>
                        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="living-tab" data-bs-toggle="tab" data-bs-target="#living" type="button" role="tab" aria-controls="living" aria-selected="true">Living / Comedor</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="dormitorios-tab" data-bs-toggle="tab" data-bs-target="#dormitorios" type="button" role="tab" aria-controls="dormitorios" aria-selected="false">Dormitorios</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="cocina-tab" data-bs-toggle="tab" data-bs-target="#cocina" type="button" role="tab" aria-controls="cocina" aria-selected="false">Cocina y Lavadero</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="oficina-tab" data-bs-toggle="tab" data-bs-target="#oficina" type="button" role="tab" aria-controls="oficina" aria-selected="false">Oficina</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="otros-tab" data-bs-toggle="tab" data-bs-target="#otros" type="button" role="tab" aria-controls="otros" aria-selected="false">Otros / Genérico</button>
                            </li>
                        </ul>

                        <div class="tab-content" id="myTabContent">
                            <div class="tab-pane fade show active" id="living" role="tabpanel" aria-labelledby="living-tab">
                                <h5 class="mb-3">Elementos disponibles en Living / Comedor:</h5>
                                <div class="row row-cols-3 row-cols-md-4 g-3">
                                    <div class="col">
                                        <div class="item-card" data-item-id="biblioteca" data-volume="1.2" data-item-name="Biblioteca">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="4" y="3" width="16" height="18" rx="2"/><path d="M8 3v18M16 3v18M4 8h16M4 14h16"/></svg>
                                            <span>Biblioteca</span>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="item-card" data-item-id="sillon-2" data-volume="0.8" data-item-name="Sillón 2 cuerpos">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="10" width="18" height="7" rx="2"/><path d="M5 10V8a3 3 0 0 1 3-3h8a3 3 0 0 1 3 3v2"/><path d="M7 17v2M17 17v2"/></svg>
                                            <span>Sillón 2 cuerpos</span>
                                        </div>
                                    </div>
                                    
                                    <div class="col">
                                        <div class="item-card" data-item-id="sillon-3" data-volume="1.2" data-item-name="Sillón 3 cuerpos">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="10" width="18" height="7" rx="2"/><path d="M5 10V8a3 3 0 0 1 3-3h8a3 3 0 0 1 3 3v2"/><path d="M7 17v2M17 17v2"/></svg>
                                            <span>Sillón 3 cuerpos</span>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="item-card" data-item-id="mesa-tv" data-volume="0.4" data-item-name="Mesa de TV">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="6" width="18" height="11" rx="2"/><path d="M12 6 8 3M12 6l4-3"/></svg>
                                            <span>Mesa de TV</span>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="item-card" data-item-id="silla" data-volume="0.15" data-item-name="Silla">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                              <path d="M8 4h8v6H8z"/>
                                              <path d="M7 10h10"/>
                                              <path d="M9 10v7M15 10v7"/>
                                            </svg>
                                            <span>Silla</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="dormitorios" role="tabpanel" aria-labelledby="dormitorios-tab">
                                <h5 class="mb-3">Elementos disponibles en Dormitorios:</h5>
                                <div class="row row-cols-3 row-cols-md-4 g-3">
                                    <div class="col">
                                        <div class="item-card" data-item-id="cama-doble" data-volume="2.0" data-item-name="Cama Doble">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 12h18v5H3z"/><path d="M6 7h6v5H6z"/></svg>
                                            <span>Cama Doble</span>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="item-card" data-item-id="ropero-2puertas" data-volume="1.8" data-item-name="Ropero 2 Puertas">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="5" y="3" width="14" height="18" rx="2"/><path d="M12 3v18"/><path d="M10 12h.01M14 12h.01"/></svg>
                                            <span>Ropero 2 Puertas</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="cocina" role="tabpanel" aria-labelledby="cocina-tab">
                                <h5 class="mb-3">Elementos disponibles en Cocina y Lavadero:</h5>
                                <div class="row row-cols-3 row-cols-md-4 g-3">
                                    <div class="col">
                                        <div class="item-card" data-item-id="heladera" data-volume="0.7" data-item-name="Heladera">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="7" y="3" width="10" height="18" rx="2"/><path d="M7 10h10"/><path d="M9 8v2M9 13v3"/></svg>
                                            <span>Heladera</span>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="item-card" data-item-id="cocina" data-volume="0.5" data-item-name="Cocina">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="4" y="6" width="16" height="12" rx="2"/><circle cx="8" cy="10" r="1.5"/><circle cx="12" cy="10" r="1.5"/><circle cx="16" cy="10" r="1.5"/></svg>
                                            <span>Cocina</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="oficina" role="tabpanel" aria-labelledby="oficina-tab">
                                <h5 class="mb-3">Elementos disponibles en Oficina:</h5>
                                <div class="row row-cols-3 row-cols-md-4 g-3">
                                    <div class="col">
                                        <div class="item-card" data-item-id="escritorio" data-volume="0.6" data-item-name="Escritorio">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="6" width="18" height="11" rx="2"/><path d="M8 20h8M12 17v3"/></svg>
                                            <span>Escritorio</span>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="item-card" data-item-id="sillon-oficina" data-volume="0.4" data-item-name="Sillón de Oficina">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                              <rect x="8" y="5" width="8" height="6" rx="1"/>
                                              <path d="M12 11v3M9 14h6"/>
                                              <path d="M10 18h-2M16 18h-2"/>
                                              <circle cx="8" cy="19" r="1"/>
                                              <circle cx="16" cy="19" r="1"/>
                                            </svg>
                                            <span>Sillón de Oficina</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="otros" role="tabpanel" aria-labelledby="otros-tab">
                                <h5 class="mb-3">Ingrese el volumen de otros objetos no listados (en m³):</h5>
                                <div id="genericItemsContainer">
                                    <div class="input-group mb-2 generic-item-row">
                                        <input type="text" class="form-control generic-item-description" placeholder="Ej: Caja Grande">
                                        <input type="number" step="0.1" class="form-control generic-item-volume" placeholder="Volumen (m³)" min="0.1">
                                        <button type="button" class="btn btn-outline-danger remove-generic-item-btn"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <button type="button" id="addGenericItemBtn" class="btn btn-outline-secondary btn-sm mt-2">Añadir otro objeto genérico</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5 ps-lg-4">
                        <ul class="nav nav-tabs mb-3" id="rightPaneTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#tabResumen" type="button" role="tab" aria-controls="tabResumen" aria-selected="true">Seleccionados</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link disabled" id="contacto-tab" type="button" role="tab" aria-controls="tabContacto" aria-selected="false" aria-disabled="true" tabindex="-1">Contacto</button>
                            </li>
                        </ul>

                        <div class="tab-content" id="rightPaneContent">
                            <div class="tab-pane fade show active" id="tabResumen" role="tabpanel" aria-labelledby="summary-tab">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="mb-0">Elementos seleccionados para guardar:</h4>
                                    <button type="button" id="clearSelectedBtn" class="btn btn-link btn-sm text-danger p-0">
                                        Limpiar
                                    </button>
                                </div>
                                <ul id="selectedItemsList" class="selected-item-list">
                                    <li id="noItemsMessage" class="text-muted text-center">No hay ítems seleccionados.</li>
                                </ul>

                                <div id="genericSummary" class="mt-3">
                                    <h6 class="mb-2 text-muted">Ítems genéricos ingresados:</h6>
                                    <ul id="genericSummaryList" class="selected-item-list">
                                        <li id="noGenericMessage" class="text-muted text-center">No hay ítems genéricos.</li>
                                    </ul>
                                </div>

                                <div class="mt-4 p-3 total-volume-display-container">
                                    <h5>Espacio necesario estimado:</h5>
                                    <strong id="totalVolumeDisplay">0.00 m³</strong>
                                    <div class="text-muted mt-2">Ítems distintos: <strong id="distinctItemsCount">0</strong></div>
                                </div>
                                
                                <div class="mt-3">
                                    <div class="row g-2">
                                        <div class="col-12 col-sm-6 d-grid">
                                            <button type="button" id="calculatePriceBtn" class="btn btn-primary btn-lg">Calcular Precio</button>
                                        </div>
                                        <div class="col-12 col-sm-6 d-grid">
                                            <button type="button" id="copySummaryBtn" class="btn btn-outline-secondary btn-lg">Copiar Resumen</button>
                                        </div>
                                    </div>
                                </div>

                                <div id="resultSection" class="mt-4 p-3 rounded" style="display: none;">
                                    <h4 class="text-center">Resultado del Cálculo</h4>
                                    <div id="calculationResult" class="lead text-center mb-3"></div>
                                    <div id="boxRecommendation" class="text-center text-muted small"></div>
                                    <p class="text-center mt-3 mb-0 text-muted">
                                        <small>Nota: Precios estimados entre $5.000 y $10.000 ARS por m³.</small>
                                    </p>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="tabContacto" role="tabpanel" aria-labelledby="contacto-tab">
                                <div id="registrationSection" class="card mt-2 p-4 shadow-sm" style="display: none;">
                                    <h3 class="card-title text-center mb-4">Registrar y Reservar</h3>
                                    <form id="registrationForm" action="{{ url_for('registrar_producto') }}" method="POST">
                                        <input type="hidden" id="regTipoObjeto" name="tipo_objeto">
                                        <input type="hidden" id="regNombreObjeto" name="nombre_objeto">
                                        <input type="hidden" id="regVolumen" name="volumen">
                                        <input type="hidden" id="regPrecio" name="precio_calculado">
                                        <input type="hidden" id="regCaja" name="caja_recomendada">

                                        <div class="mb-3">
                                            <label for="nombreCliente" class="form-label">Tu Nombre:</label>
                                            <input type="text" class="form-control" id="nombreCliente" name="nombre_cliente" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="emailCliente" class="form-label">Tu Email:</label>
                                            <input type="email" class="form-control" id="emailCliente" name="email_cliente" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="telefonoCliente" class="form-label">Teléfono (opcional):</label>
                                            <input type="tel" class="form-control" id="telefonoCliente" name="telefono_cliente">
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-success">Confirmar Registro y Reserva</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const itemCards = document.querySelectorAll('.item-card');
            const selectedItemsList = document.getElementById('selectedItemsList');
            const noItemsMessage = document.getElementById('noItemsMessage');
            const genericSummaryList = document.getElementById('genericSummaryList');
            const noGenericMessage = document.getElementById('noGenericMessage');
            const totalVolumeDisplay = document.getElementById('totalVolumeDisplay');
            const distinctItemsCount = document.getElementById('distinctItemsCount');
            const calculatePriceBtn = document.getElementById('calculatePriceBtn');
            const copySummaryBtn = document.getElementById('copySummaryBtn');
            const resultSection = document.getElementById('resultSection');
            const calculationResultDiv = document.getElementById('calculationResult');
            const boxRecommendationDiv = document.getElementById('boxRecommendation');
            const registrationSection = document.getElementById('registrationSection');
            const contactTab = document.getElementById('contacto-tab');
            const clearSelectedBtn = document.getElementById('clearSelectedBtn');

            const addGenericItemBtn = document.getElementById('addGenericItemBtn');
            const genericItemsContainer = document.getElementById('genericItemsContainer');

            const regTipoObjeto = document.getElementById('regTipoObjeto');
            const regNombreObjeto = document.getElementById('regNombreObjeto');
            const regVolumen = document.getElementById('regVolumen');
            const regPrecio = document.getElementById('regPrecio');
            const regCaja = document.getElementById('regCaja');

            const selectedItems = {};

            function updateSelectedItemsDisplay() {
                selectedItemsList.innerHTML = '';
                genericSummaryList.innerHTML = '';
                let totalVolume = 0;
                let hasItems = false;
                let distinct = 0;

                for (const id in selectedItems) {
                    const item = selectedItems[id];
                    if (item.quantity > 0) {
                        hasItems = true;
                        distinct++;
                        totalVolume += item.volume * item.quantity;

                        const li = document.createElement('li');
                        li.dataset.itemId = id;
                        li.innerHTML = `
                            <span class="item-name">${item.name}</span>
                            <div class="item-controls">
                                <button type="button" class="btn btn-sm btn-outline-secondary minus-btn" data-item-id="${id}"><i class="fas fa-minus"></i></button>
                                <span class="badge bg-primary text-white rounded-pill me-2">${item.quantity}</span> {# Forzado text-white para que siempre se vea bien en el badge primario #}
                                <button type="button" class="btn btn-sm btn-outline-secondary plus-btn" data-item-id="${id}"><i class="fas fa-plus"></i></button>
                                <button type="button" class="btn btn-sm btn-danger remove-item-btn" data-item-id="${id}"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        selectedItemsList.appendChild(li);
                    }
                }

                // Agregar apartado de genéricos (nombre + volumen)
                let hasGenerics = false;
                const genericRows = Array.from(document.querySelectorAll('.generic-item-row'));
                genericRows.forEach((row, idx) => {
                    const desc = row.querySelector('.generic-item-description')?.value.trim();
                    const volRaw = row.querySelector('.generic-item-volume')?.value;
                    const vol = parseFloat(volRaw);
                    const hasSomeInput = (desc && desc.length) || (volRaw && volRaw.length);
                    if (hasSomeInput) {
                        hasItems = true;
                        hasGenerics = true;
                        distinct++;
                        if (!isNaN(vol) && vol > 0) totalVolume += vol;
                        const li = document.createElement('li');
                        const volLabel = (!isNaN(vol) && vol > 0) ? `${vol.toFixed(2)} m³` : '—';
                        li.innerHTML = `
                            <span class="item-name">${desc || 'Objeto genérico'}</span>
                            <div class="item-controls">
                                <span class="badge bg-primary text-white rounded-pill me-2">${volLabel}</span>
                                <button type="button" class="btn btn-sm btn-danger remove-generic-from-list" data-generic-index="${idx}"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        genericSummaryList.appendChild(li);
                    }
                });
                // Mensajes vacíos
                noGenericMessage.style.display = hasGenerics ? 'none' : 'block';

                if (!hasItems) {
                    noItemsMessage.style.display = 'block';
                } else {
                    noItemsMessage.style.display = 'none';
                }

                totalVolumeDisplay.textContent = (totalVolume + getGenericItemsTotalVolume()).toFixed(2) + ' m³'; 
                if (distinctItemsCount) distinctItemsCount.textContent = String(distinct);
                updateVisibilityOfResultAndRegistration();
            }

            function handleItemClick(event) {
                const card = event.currentTarget;
                const itemId = card.dataset.itemId;
                const itemName = card.dataset.itemName;
                const itemVolume = parseFloat(card.dataset.volume);

                if (selectedItems[itemId]) {
                    selectedItems[itemId].quantity++;
                } else {
                    selectedItems[itemId] = { name: itemName, volume: itemVolume, quantity: 1 };
                }
                updateSelectedItemsDisplay();
            }

            function adjustItemQuantity(event) {
                const btn = event.target.closest('button');
                if (!btn) return;
                const itemId = btn.dataset.itemId;

                if (btn.classList.contains('plus-btn')) {
                    selectedItems[itemId].quantity++;
                } else if (btn.classList.contains('minus-btn')) {
                    selectedItems[itemId].quantity--;
                    if (selectedItems[itemId].quantity <= 0) {
                        delete selectedItems[itemId];
                    }
                } else if (btn.classList.contains('remove-item-btn')) {
                    delete selectedItems[itemId];
                }
                updateSelectedItemsDisplay();
            }

            function clearSelectedItems() {
                for (const id in selectedItems) {
                    delete selectedItems[id];
                }
                document.querySelectorAll('.generic-item-row').forEach(row => row.remove());
                updateSelectedItemsDisplay();
            }

            itemCards.forEach(card => {
                card.addEventListener('click', handleItemClick);
            });

            selectedItemsList.addEventListener('click', function(e){
                const btn = e.target.closest('button');
                if (!btn) return;
                if (btn.classList.contains('remove-generic-from-list')) {
                    const idx = parseInt(btn.dataset.genericIndex, 10);
                    const rows = Array.from(document.querySelectorAll('.generic-item-row'));
                    if (!isNaN(idx) && rows[idx]) {
                        rows[idx].remove();
                        updateProvisionalTotalGeneric();
                        updateSelectedItemsDisplay();
                    }
                    return;
                }
                adjustItemQuantity(e);
            });

            genericSummaryList.addEventListener('click', function(e){
                const btn = e.target.closest('button');
                if (!btn) return;
                if (btn.classList.contains('remove-generic-from-list')) {
                    const idx = parseInt(btn.dataset.genericIndex, 10);
                    const rows = Array.from(document.querySelectorAll('.generic-item-row'));
                    if (!isNaN(idx) && rows[idx]) {
                        rows[idx].remove();
                        updateProvisionalTotalGeneric();
                        updateSelectedItemsDisplay();
                    }
                }
            });

            clearSelectedBtn.addEventListener('click', clearSelectedItems);

            // Copiar resumen al portapapeles
            if (copySummaryBtn) {
                copySummaryBtn.addEventListener('click', function() {
                    let lines = [];
                    for (const id in selectedItems) {
                        const it = selectedItems[id];
                        if (it.quantity > 0) {
                            lines.push(`- ${it.name} x${it.quantity} (${(it.volume * it.quantity).toFixed(2)} m³)`);
                        }
                    }
                    document.querySelectorAll('.generic-item-row').forEach(row => {
                        const desc = row.querySelector('.generic-item-description')?.value.trim();
                        const vol = parseFloat(row.querySelector('.generic-item-volume')?.value);
                        if (!isNaN(vol) && vol > 0) {
                            lines.push(`- ${desc || 'Objeto genérico'} (${vol.toFixed(2)} m³)`);
                        }
                    });
                    const total = totalVolumeDisplay.textContent || '';
                    const text = `Resumen de selección\n${lines.join('\n')}\nTotal: ${total}`.trim();
                    if (navigator.clipboard?.writeText) {
                        navigator.clipboard.writeText(text).then(() => {
                            alert('Resumen copiado al portapapeles.');
                        }).catch(() => {
                            fallbackCopy(text);
                        });
                    } else {
                        fallbackCopy(text);
                    }
                    function fallbackCopy(t) {
                        const ta = document.createElement('textarea');
                        ta.value = t; document.body.appendChild(ta); ta.select();
                        try { document.execCommand('copy'); alert('Resumen copiado al portapapeles.'); } catch(e) {}
                        ta.remove();
                    }
                });
            }

            function addGenericInputField() {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('input-group', 'mb-2', 'generic-item-row');
                itemDiv.innerHTML = `
                    <input type="text" class="form-control generic-item-description" placeholder="Ej: Caja Grande">
                    <input type="number" step="0.1" class="form-control generic-item-volume" placeholder="Volumen (m³)" min="0.1">
                    <button type="button" class="btn btn-outline-danger remove-generic-item-btn"><i class="fas fa-trash"></i></button>
                `;
                genericItemsContainer.appendChild(itemDiv);
                itemDiv.querySelector('.generic-item-volume').addEventListener('input', updateProvisionalTotalGeneric);
                itemDiv.querySelector('.remove-generic-item-btn').addEventListener('click', function() {
                    itemDiv.remove();
                    updateProvisionalTotalGeneric();
                    updateSelectedItemsDisplay();
                });
                updateProvisionalTotalGeneric();
                updateSelectedItemsDisplay();
            }

            function updateProvisionalTotalGeneric() {
                let totalGeneric = 0;
                document.querySelectorAll('.generic-item-volume').forEach(input => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value) && value > 0) {
                        totalGeneric += value;
                    }
                    if (input.value === "" || isNaN(value)) {
                        input.classList.add('is-invalid'); 
                    } else {
                        input.classList.remove('is-invalid');
                    }
                });
                totalVolumeDisplay.textContent = (getPredefinedItemsTotalVolume() + totalGeneric).toFixed(2) + ' m³'; 
                updateVisibilityOfResultAndRegistration();
            }

            addGenericItemBtn.addEventListener('click', addGenericInputField);

            genericItemsContainer.addEventListener('input', function(event) {
                updateProvisionalTotalGeneric();
                updateSelectedItemsDisplay();
            });

            function getPredefinedItemsTotalVolume() {
                let total = 0;
                for (const id in selectedItems) {
                    const item = selectedItems[id];
                    total += item.volume * item.quantity;
                }
                return total;
            }

            function getGenericItemsTotalVolume() {
                let total = 0;
                document.querySelectorAll('.generic-item-volume').forEach(input => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value) && value > 0) {
                        total += value;
                    }
                    if (input.value === "" || isNaN(value)) {
                        input.classList.add('is-invalid'); 
                    } else {
                        input.classList.remove('is-invalid');
                    }
                });
                return total;
            }
            
            document.querySelectorAll('.nav-link').forEach(tabBtn => {
                tabBtn.addEventListener('shown.bs.tab', function (event) {
                    updateProvisionalTotalGeneric(); 
                });
            });
            // Permitir que "Otros/Genérico" quede vacío si el usuario elimina filas


            calculatePriceBtn.addEventListener('click', async function() {
                let totalCalculatedVolume = getPredefinedItemsTotalVolume() + getGenericItemsTotalVolume();

                const genericVolumeInputs = document.querySelectorAll('.generic-item-volume');
                let allGenericVolumesValid = true;
                genericVolumeInputs.forEach(input => {
                    const value = parseFloat(input.value);
                    const description = input.previousElementSibling.value.trim();
                    if ((description && (isNaN(value) || value <= 0)) || (!description && (isNaN(value) || value <= 0) && genericVolumeInputs.length > 1) ) {
                        input.classList.add('is-invalid');
                        allGenericVolumesValid = false;
                    } else {
                        input.classList.remove('is-invalid');
                    }
                });

                if (!allGenericVolumesValid) {
                    alert('Por favor, complete los volúmenes de los objetos genéricos o elimine las filas vacías/inválidas.');
                    resultSection.style.display = 'none';
                    registrationSection.style.display = 'none';
                    if (contactTab) {
                        contactTab.classList.add('disabled');
                        contactTab.setAttribute('aria-disabled','true');
                        contactTab.setAttribute('tabindex','-1');
                        if (window.bootstrap && bootstrap.Tab) {
                            bootstrap.Tab.getOrCreateInstance(document.getElementById('summary-tab')).show();
                        }
                    }
                    return;
                }

                if (totalCalculatedVolume <= 0) {
                    alert('Por favor, seleccione o ingrese al menos un volumen válido para calcular el precio.');
                    resultSection.style.display = 'none';
                    registrationSection.style.display = 'none';
                    if (contactTab) {
                        contactTab.classList.add('disabled');
                        contactTab.setAttribute('aria-disabled','true');
                        contactTab.setAttribute('tabindex','-1');
                        if (window.bootstrap && bootstrap.Tab) {
                            bootstrap.Tab.getOrCreateInstance(document.getElementById('summary-tab')).show();
                        }
                    }
                    return;
                }

                try {
                    const res = await fetch('/depositoweb/calcular_precio', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ volumen: totalCalculatedVolume })
                    });
                    const data = await res.json();

                    if (data.precio) {
                        calculationResultDiv.innerHTML = `El precio estimado es: <strong>$${data.precio}</strong> ARS`;
                        boxRecommendationDiv.innerHTML = `Caja recomendada: <strong>${data.caja_recomendada}</strong>`;
                        resultSection.style.display = 'block';
                        registrationSection.style.display = 'block';
                        // Habilitar pestaña de contacto y activarla
                        if (contactTab) {
                            contactTab.classList.remove('disabled');
                            contactTab.removeAttribute('aria-disabled');
                            contactTab.removeAttribute('tabindex');
                            if (window.bootstrap && bootstrap.Tab) {
                                bootstrap.Tab.getOrCreateInstance(contactTab).show();
                            } else {
                                // Fallback simple: activar clases manualmente
                                document.getElementById('summary-tab').classList.remove('active');
                                document.getElementById('tabResumen').classList.remove('show','active');
                                contactTab.classList.add('active');
                                document.getElementById('tabContacto').classList.add('show','active');
                            }
                        }

                        let combinedObjectName = [];
                        for(const id in selectedItems) {
                            if(selectedItems[id].quantity > 0) {
                                combinedObjectName.push(`${selectedItems[id].name} (x${selectedItems[id].quantity})`);
                            }
                        }
                        document.querySelectorAll('.generic-item-row').forEach(row => {
                            const desc = row.querySelector('.generic-item-description').value.trim();
                            const vol = parseFloat(row.querySelector('.generic-item-volume').value);
                            if(desc && !isNaN(vol) && vol > 0) {
                                combinedObjectName.push(`${desc} (${vol}m³)`);
                            } else if (!isNaN(vol) && vol > 0) {
                                combinedObjectName.push(`Objeto genérico (${vol}m³)`);
                            }
                        });

                        regTipoObjeto.value = combinedObjectName.length > 0 ? 'Combinado' : 'Desconocido';
                        regNombreObjeto.value = combinedObjectName.length > 0 ? combinedObjectName.join(', ') : 'No especificado';
                        regVolumen.value = totalCalculatedVolume.toFixed(2);
                        regPrecio.value = data.precio;
                        regCaja.value = data.caja_recomendada;

                    } else {
                        calculationResultDiv.innerText = 'Error: ' + data.error;
                        boxRecommendationDiv.innerText = '';
                        resultSection.style.display = 'block';
                        registrationSection.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error al calcular el precio:', error);
                    calculationResultDiv.innerText = 'Error de conexión con el servidor.';
                    boxRecommendationDiv.innerText = '';
                    resultSection.style.display = 'block';
                    registrationSection.style.display = 'none';
                    if (contactTab) {
                        contactTab.classList.add('disabled');
                        contactTab.setAttribute('aria-disabled','true');
                        contactTab.setAttribute('tabindex','-1');
                        if (window.bootstrap && bootstrap.Tab) {
                            bootstrap.Tab.getOrCreateInstance(document.getElementById('summary-tab')).show();
                        }
                    }
                }
            });

            function updateVisibilityOfResultAndRegistration() {
                const totalCurrentVolume = getPredefinedItemsTotalVolume() + getGenericItemsTotalVolume();
                if (totalCurrentVolume > 0) {
                    resultSection.style.display = 'none'; 
                    registrationSection.style.display = 'none';
                } else {
                    resultSection.style.display = 'none';
                    registrationSection.style.display = 'none';
                }
            }
            updateVisibilityOfResultAndRegistration();
        });
    </script>
{% endblock %}
